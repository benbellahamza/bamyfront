<div class="flex flex-col min-h-screen bg-gradient-to-br from-slate-100 to-slate-300 overflow-hidden">

  <!-- âœ… HEADER FIXE -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-slate-700 text-white p-4 shadow flex items-center justify-between">
    <div class="flex items-center gap-4">
      <img src="assets/images/user-icon.png" alt="Logo" class="w-10 h-10 object-contain" />
      <span class="text-black font-bold text-lg">BAMY TRUCKS</span>
    </div>
    <h1 class="absolute left-1/2 transform -translate-x-1/2 text-xl font-bold font-mono tracking-widest uppercase text-center">
      Dashboard Admin
    </h1>
    <div class="relative">
      <div class="w-10 h-10 rounded-full bg-white text-slate-800 flex items-center justify-center font-bold cursor-pointer"
           (click)="menuOuvert = !menuOuvert">
        {{ utilisateur.nom.charAt(0) }}
      </div>
    </div>
  </header>

  <!-- âœ… MENU UTILISATEUR -->
  <div *ngIf="menuOuvert"
       class="fixed top-16 right-4 w-64 bg-white text-slate-800 shadow-lg rounded-md p-4 z-[100] space-y-2">
    <div class="font-semibold text-sm flex items-center gap-2"><span>ğŸ‘¤</span>{{ utilisateur.nom }} {{ utilisateur.prenom }}</div>
    <div class="text-sm flex items-center gap-2"><span>ğŸ“§</span>{{ utilisateur.email }}</div>
    <div class="text-sm flex items-center gap-2"><span>ğŸ”</span>{{ utilisateur.role }}</div>
    <hr>
    <div class="text-sm text-blue-600 hover:text-blue-800 cursor-pointer flex items-center gap-2"
         (click)="ouvrirModalePassword()">ğŸ”‘ Modifier mot de passe</div>
    <div class="text-sm text-red-600 hover:text-red-800 cursor-pointer flex items-center gap-2"
         (click)="logout()">ğŸšª Se dÃ©connecter</div>
  </div>

  <!-- âœ… MODALE MOT DE PASSE -->
  <div *ngIf="modalePasswordVisible" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-[200]">
    <div class="bg-white rounded-lg p-6 w-full max-w-md space-y-4 shadow-lg">
      <h2 class="text-lg font-bold text-center text-slate-800">Modifier le mot de passe</h2>
      <input type="password" [(ngModel)]="ancienMotDePasse" placeholder="Ancien mot de passe" class="input input-bordered w-full" />
      <input type="password" [(ngModel)]="nouveauMotDePasse" placeholder="Nouveau mot de passe" class="input input-bordered w-full" />
      <div class="flex justify-end gap-4 mt-4">
        <button class="btn btn-outline" (click)="fermerModalePassword()">Annuler</button>
        <button class="btn btn-primary" (click)="changerMotDePasse()">Enregistrer</button>
      </div>
      <div *ngIf="messageSuccess" class="text-green-600 text-sm text-center">{{ messageSuccess }}</div>
      <div *ngIf="messageErreur" class="text-red-600 text-sm text-center">{{ messageErreur }}</div>
    </div>
  </div>

  <!-- âœ… CONTENU PRINCIPAL -->
  <main class="flex-1 mt-[90px] px-4 pb-28">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-[calc(100vh-230px)]">

      <!-- âœ… Liste des utilisateurs -->
      <div class="col-span-2 bg-white shadow-lg rounded-xl p-4 flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold">ğŸ‘¥ Liste des utilisateurs</h2>
          <a routerLink="/ajouterUtilisateur" class="btn btn-primary">â• Ajouter</a>
        </div>
        <div class="overflow-y-auto flex-1">
          <table class="table w-full text-sm text-center">
            <thead class="bg-base-200 text-base font-semibold">
              <tr>
                <th>Avatar</th>
                <th>Nom</th>
                <th>Email</th>
                <th>RÃ´le</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of utilisateurs">
                <td>
                  <div class="avatar placeholder">
                    <div class="bg-primary text-white rounded-full w-10">
                      <span class="text-sm">{{ user.nom[0] }}{{ user.prenom[0] }}</span>
                    </div>
                  </div>
                </td>
                <td>{{ user.nom }} {{ user.prenom }}</td>
                <td>{{ user.email }}</td>
                <td>
                  <div class="badge"
                       [ngClass]="{
                         'badge-primary': user.role === 'ADMIN',
                         'badge-info': user.role === 'AGENT',
                         'badge-warning text-black': user.role === 'RESPONSABLE'
                       }">
                    {{ user.role }}
                  </div>
                </td>
                <td>
                  <div class="badge"
                       [ngClass]="{
                         'badge-success text-white': user.actif,
                         'badge-error text-white': !user.actif
                       }">
                    {{ user.actif ? 'Actif' : 'Inactif' }}
                  </div>
                </td>
                <td class="flex gap-1 justify-center">
                  <button class="btn btn-xs btn-warning" (click)="ouvrirFormModification(user)">âœï¸</button>
                  <button class="btn btn-xs btn-error" (click)="ouvrirFormReset(user)">ğŸ”</button>
                  <button class="btn btn-xs text-white"
                          [ngClass]="{
                            'btn-neutral': user.role === 'ADMIN',
                            'btn-error': user.role !== 'ADMIN' && user.actif,
                            'btn-success': user.role !== 'ADMIN' && !user.actif
                          }"
                          [disabled]="user.role === 'ADMIN'"
                          (click)="toggleActivation(user)">
                    {{ user.role === 'ADMIN' ? 'ğŸ”’' : (user.actif ? 'ğŸ›‘' : 'ğŸŸ¢') }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- âœ… Historique -->
      <div class="bg-white shadow-lg rounded-xl p-4 flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold">ğŸ“Œ Historique des actions</h2>
          <a routerLink="/admin/historique" class="btn btn-primary btn-sm">ğŸ•“ Voir l'historique</a>
        </div>
        <div class="space-y-2 overflow-y-auto flex-1">
          <div *ngFor="let action of historiqueDashboard" class="text-sm border-b pb-2">
            <p><span class="font-bold">{{ action.nomAgent }}</span> âœ <span class="italic">{{ action.action }}</span></p>
            <p class="text-gray-500 text-xs">ğŸ•’ {{ action.dateAction | date: 'short' }}</p>
          </div>
          <div *ngIf="historiqueDashboard.length === 0" class="text-center text-gray-400">Aucune action rÃ©cente</div>
        </div>
      </div>

    </div>

    <!-- âœ… FORMULAIRE MODIF / RESET -->
    <div *ngIf="formulaireActif" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-[300]">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg space-y-4">
        <h2 class="text-lg font-bold text-center text-slate-700" *ngIf="modeForm === 'modifier'">âœï¸ Modifier l'utilisateur</h2>
        <h2 class="text-lg font-bold text-center text-slate-700" *ngIf="modeForm === 'reset'">ğŸ” RÃ©initialiser mot de passe</h2>

        <!-- Formulaire de modification -->
        <form *ngIf="modeForm === 'modifier'" [formGroup]="formModif" (ngSubmit)="soumettreModification()" class="space-y-3">
          <input type="text" formControlName="nom" placeholder="Nom" class="input input-bordered w-full" />
          <input type="text" formControlName="prenom" placeholder="PrÃ©nom" class="input input-bordered w-full" />
          <input type="email" formControlName="email" placeholder="Email" class="input input-bordered w-full" />
          <select formControlName="role" class="select select-bordered w-full">
            <option value="">-- SÃ©lectionner un rÃ´le --</option>
            <option value="ADMIN">ADMIN</option>
            <option value="AGENT">AGENT</option>
            <option value="RESPONSABLE">RESPONSABLE</option>
          </select>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" class="btn btn-outline" (click)="fermerFormulaire()">Annuler</button>
            <button type="submit" class="btn btn-primary" [disabled]="formModif.invalid">âœ… Enregistrer</button>
          </div>
        </form>

        <!-- Formulaire de reset -->
        <form *ngIf="modeForm === 'reset'" [formGroup]="formReset" (ngSubmit)="soumettreReset()" class="space-y-3">
          <input type="password" formControlName="newPassword" placeholder="Nouveau mot de passe" class="input input-bordered w-full" />
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" class="btn btn-outline" (click)="fermerFormulaire()">Annuler</button>
            <button type="submit" class="btn btn-primary" [disabled]="formReset.invalid">ğŸ” RÃ©initialiser</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- âœ… FOOTER -->
  <footer class="fixed bottom-0 left-0 right-0 bg-slate-700 text-white p-3 text-center text-xs tracking-widest">
    &copy; BAMY TRUCKS | BamyGuest
  </footer>
</div>
